---
// 全站主布局，包含头部导航、内容插槽
import '@/styles/global.css';
import NavigationBar from '@/components/NavigationBar.astro';
import CategoryList from '@/components/CategoryList.astro';
import TagList from '@/components/TagList.astro';
import ArchiveList from '@/components/ArchiveList.astro';

interface Props {
  title: string;
  description?: string;
}

const { title, description = '我的Astro博客' } = Astro.props;
---

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <script is:inline>
      // This script is executed before the page is rendered to prevent theme flashing.
      const theme = (() => {
        // 1. Check for a theme in localStorage.
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        // 2. Check for the system's preferred color scheme.
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        // 3. Default to 'light' theme.
        return 'light';
      })();

      // Apply the theme to the <html> element.
      if (theme === 'light') {
        document.documentElement.classList.remove('dark');
      } else {
        document.documentElement.classList.add('dark');
      }

      // When using Astro's View Transitions, we need to re-apply the theme after a page swap.
      document.addEventListener('astro:after-swap', () => {
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme) {
          if (storedTheme === 'dark') {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        }
        // If no theme is in storage, the initial logic based on media query will handle it,
        // but we might need to re-evaluate if the user changed system settings while browsing.
        // For simplicity, we'll rely on the stored theme. If it's not there, we don't do anything on swap,
        // assuming the initial page load script on the new page will handle it correctly.

        // Custom scroll behavior for post pages
        if (window.location.pathname.startsWith('/posts/')) {
          const avatar = document.getElementById('avatar');
          if (avatar) {
            // The avatar is positioned absolutely and centered vertically with `translate-y-1/2`.
            // `offsetTop` gives the `top` value, so we adjust by half the height to find the top edge.
            const avatarTopEdge = avatar.offsetTop - (avatar.offsetHeight / 2);
            
            // Scroll so the viewport is 21px above the avatar's top edge.
            const desiredScrollY = avatarTopEdge -21;

            // Scroll to the calculated position.
            window.scrollTo({ top: desiredScrollY, behavior: 'smooth' });
          }
        }
      });
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="keywords" content="Astro, 博客, 技术, 文章" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <title>{title}</title>
    <link rel="preload" as="image" href="/images/head_car.webp">
    <link rel="preload" as="image" href="/images/wallpaper.webp">
    <link rel="preload" as="image" href="/avatar.webp">
  </head>
  <body>
    <div class="content-wrapper">
      <div class="mx-auto my-[21px] max-w-[1152px] relative">
        <div id="header-container">
          <div class="header-placeholder relative rounded-t-xl">
            <header></header>
          </div>
          <NavigationBar />
        </div>

        <div id="main-content" class="shadow-soft-lg overflow-hidden flex" style="background-color: var(--main-content-bg);">
          <main id="swup" class="swup-transition-fade w-3/4">
            <div class="p-8">
              <slot />
            </div>
          </main>

          <aside id="sidebar" class="w-1/4 p-4 pt-24 space-y-8" style="box-shadow: var(--divider-box-shadow);">
            <CategoryList />
            <TagList />
            <ArchiveList />
          </aside>
        </div>

        <footer id="footer" class="h-[39px] p-4 flex items-center justify-end rounded-b-xl" style="background-color: var(--footer-bg); border-top: 1px solid var(--divider-shadow-dark);">
          <p class="text-sm">
            <a href="https://astro.build/" target="_blank" rel="noopener noreferrer" class="font-light text-text-primary footer-link">Self-designed, Astro-driven.</a>
          </p>
        </footer>
        
        <img id="avatar" src="/avatar.webp" alt="Avatar" width="96" height="96" class="absolute top-[468px] left-3/4 -translate-x-1/2 -translate-y-1/2 w-24 h-24 rounded-full border-4 border-white shadow-soft-lg z-10">
      </div>
    </div>
  </body>
</html>
